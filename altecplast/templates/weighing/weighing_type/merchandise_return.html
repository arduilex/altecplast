{% extends 'base.html' %}

{% block title %}Retour Marchandise{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2>Retour Marchandise</h2>
            <a href="{% url 'weighing' %}" class="btn btn-secondary">‚Üê Retour</a>
        </div>

        <form method="post" class="compact-form">
            {% csrf_token %}

           <!-- Informations de Base -->
            <div class="form-section">
                <div class="row">
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label for="weighing_number" class="form-label">Num√©ro de Pes√©e</label>
                            <input type="number" class="form-control" id="weighing_number" name="weighing_number"
                                required>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label for="supplier_id" class="form-label">Fournisseur</label>
                            <select class="form-select" id="supplier_id" name="supplier_id" required>
                                <option value="SELECT">S√©lectionner un fournisseur</option>
                                {% for supplier in suppliers %}
                                <option value="{{ supplier.id }}">{{ supplier.company_name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Informations Transport (auto-populated) -->
            <!-- Informations Transport -->
            <div class="form-section">
                <h4>Informations Transport</h4>
                <div class="row">
                    <div class="col-md-3">
                        <div class="mb-3">
                            <label for="transporter" class="form-label">Transporteur</label>
                            <div class="d-flex align-items-center">
                                <input type="text" class="form-control me-2" id="transporter" name="transporter">
                                <button type="button" class="btn btn-sm btn-outline-secondary"
                                    onclick="$('#transporter').val('LUI-MEME')">
                                    üéØ
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="mb-3">
                            <label for="origin" class="form-label">Origine</label>
                            <input type="text" class="form-control" id="origin" name="origin">
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="mb-3">
                            <label for="vehicle_type" class="form-label">Type de V√©hicule</label>
                            <select class="form-select" id="vehicle_type" name="vehicle_type">
                                <option value="SELECT">S√©lectionner un type</option>
                                <option value="CAMION 10G">Camion 10G</option>
                                <option value="CAMION 8G">Camion 8G</option>
                                <option value="CAMION 6G">Camion 6G</option>
                                <option value="CAMION 5G">Camion 5G</option>
                                <option value="CAMIONNETTE">Camionnette</option>
                                <option value="PICK-UP">Pick-Up</option>
                                <option value="REMORQUE">Remorque</option>
                                <option value="CONTENEUR">Conteneur</option>
                                <option value="TRAFFIC">Traffic</option>
                                <option value="AUTRE">Autre</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="mb-3">
                            <label for="license_plate" class="form-label">Plaque d'Immatriculation</label>
                            <input type="text" class="form-control" id="license_plate" name="license_plate">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Calculs de Poids -->
            <div class="form-section weight-calculation">
                <h4>Calculs de Poids</h4>
                <div class="row">
                    <div class="col-md-2">
                        <div class="mb-3">
                            <label for="gross_weight_kg" class="form-label">Poids Brut (kg)</label>
                            <input type="number" class="form-control" id="gross_weight_kg" name="gross_weight_kg"
                                required>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="mb-3">
                            <label for="tare_weight" class="form-label">Tare (kg)</label>
                            <input type="number" class="form-control" id="tare_weight" name="tare_weight" required>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="mb-3">
                            <label for="net_weight_1_kg" class="form-label">Net 1 (kg)</label>
                            <input type="number" class="form-control" id="net_weight_1_kg" name="net_weight_1_kg"
                                readonly>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="mb-3">
                            <label for="deduction_amount" class="form-label">D√©duction</label>
                            <input type="number" class="form-control" id="deduction_amount" name="deduction_amount"
                                step="1.0">
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="mb-3">
                            <label for="deduction_type" class="form-label">Type</label>
                            <select class="form-select" id="deduction_type" name="deduction_type">
                                <option value="%">%</option>
                                <option value="kg">kg</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="mb-3">
                            <label for="net_weight_2_kg" class="form-label">Net Final (kg)</label>
                            <input type="number" class="form-control" id="net_weight_2_kg" name="net_weight_2_kg"
                                readonly>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Informations Produit (auto-populated) -->
            <div class="form-section">
                <div class="row">
                    <div class="col-md-6">
                        <h4>Informations Produit</h4>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="product" class="form-label">Produit</label>
                                    <select class="form-select" id="product" name="product">
                                        <option value="SELECT">S√©lectionner un produit</option>
                                        <option value="PLASTIQUE">Plastique</option>
                                        <option value="PURGES">Purges</option>
                                        <option value="CARTON">Carton</option>
                                        <option value="BOIS">Bois</option>
                                        <option value="FERREUX">Ferreux</option>
                                        <option value="AUTRE">Autre</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="form" class="form-label">Forme</label>
                                    <select class="form-select" id="form" name="form">
                                        <option value="SELECT">S√©lectionner une forme</option>
                                        <option value="BRUT">Brut</option>
                                        <option value="DECHET">D√©chet</option>
                                        <option value="BROYE">Broy√©</option>
                                        <option value="GRANULES">Granul√©s</option>
                                        <option value="DENSIFIE">Densifi√©</option>
                                        <option value="AUTRE">Autre</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="product_type" class="form-label">Type de Produit</label>
                                    <select class="form-select" id="product_type" name="product_type">
                                        <option value="SELECT">S√©lectionner un type</option>
                                        <option value="PELD">PELD</option>
                                        <option value="PP">PP</option>
                                        <option value="PET">PET</option>
                                        <option value="PEHD">PEHD</option>
                                        <option value="PS CHOC">PS Choc</option>
                                        <option value="PALETTE">Palette</option>
                                        <option value="BOIS CASSE">Bois Cass√©</option>
                                        <option value="ALUMINIUM">Aluminium</option>
                                        <option value="FERRAILLE">Ferraille</option>
                                        <option value="AUTRE">Autre</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="color_quality" class="form-label">Couleur/Qualit√©</label>
                                    <select class="form-select" id="color_quality" name="color_quality">
                                        <option value="SELECT">S√©lectionner couleur/qualit√©</option>
                                        <option value="BEURRE">Beurre</option>
                                        <option value="FRAICH">Fra√Æch</option>
                                        <option value="SERRE">Serre</option>
                                        <option value="DOUBLE FACE">Double Face</option>
                                        <option value="PAILLAGE">Paillage</option>
                                        <option value="TRIE BLANC">Tri√© Blanc</option>
                                        <option value="TRIE COULEURS">Tri√© Couleur</option>
                                        <option value="TRIE BLANC COULEUR">Tri√© Blanc+Couleur</option>
                                        <option value="POST INDUS PROPRE">Post Indus Propre</option>
                                        <option value="POST INDUS SALE">Post Indus Sale</option>
                                        <option value="DECHARGE">D√©charge</option>
                                        <option value="TRIE BLANC+COULEURS">Tri√© (Blanc+couleur)</option>
                                        <option value="AUTRE">Autre</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h4>Emballage</h4>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="packaging" class="form-label">Emballage</label>
                                    <select class="form-select" id="packaging" name="packaging">
                                        <option value="SELECT">S√©lectionner emballage</option>
                                        <option value="VRAC">Vrac</option>
                                        <option value="BALLE">Balle</option>
                                        <option value="COLIS">Colis</option>
                                        <option value="SAC">Sac</option>
                                        <option value="BIG_BAG">Big-bag</option>
                                        <option value="AUTRE">Autre</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="packaging_quantity" class="form-label">Quantit√©</label>
                                    <input type="number" class="form-control" id="packaging_quantity"
                                        name="packaging_quantity">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-12">
                    <button type="submit" class="btn btn-primary btn-lg">Enregistrer la Pes√©e</button>
                    <a href="{% url 'weighing' %}" class="btn btn-secondary btn-lg ms-2">Annuler</a>
                </div>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    $(document).ready(function () {
        // Auto-populate fields when supplier is selected
        $('#supplier_id').change(function () {
            var supplierId = $(this).val();
            if (supplierId) {
                // Make AJAX call to get supplier defaults
                $.get('{% url "get_supplier_defaults" %}', { supplier_id: supplierId }, function (data) {
                    $('#transporter').val(data.default_transporter || '');
                    $('#origin').val(data.default_origin || '');
                    $('#vehicle_type').val(data.default_vehicle_type || '');
                    $('#license_plate').val(data.default_license_plate || '');
                    $('#product').val(data.default_product || '');
                    $('#product_type').val(data.default_product_type || '');
                    $('#form').val(data.default_form || '');
                    $('#color_quality').val(data.default_color_quality || '');
                    $('#packaging').val(data.default_packaging || '');
                    $('#packaging_quantity').val(data.default_packaging_quantity || '');
                });
            } else {
                // Clear all auto-populated fields
                $('#transporter, #origin, #vehicle_type, #license_plate, #product, #product_type, #form, #color_quality, #packaging, #packaging_quantity').val('');
            }
        });

        // Calculate net weights automatically
        function calculateWeights() {
            var grossWeight = parseFloat($('#gross_weight_kg').val()) || 0;
            var tareWeight = parseFloat($('#tare_weight').val()) || 0;
            var deductionAmount = parseFloat($('#deduction_amount').val()) || 0;
            var deductionType = $('#deduction_type').val();

            // Calculate net weight 1 (gross - tare)
            var netWeight1 = grossWeight - tareWeight;
            $('#net_weight_1_kg').val(netWeight1);

            // Calculate net weight 2 (with deduction)
            var netWeight2 = netWeight1;
            if (deductionAmount > 0) {
                if (deductionType === '%') {
                    // Percentage deduction
                    netWeight2 = netWeight1 - (netWeight1 * deductionAmount / 100);
                } else {
                    // Weight deduction in kg
                    netWeight2 = netWeight1 - deductionAmount;
                }
            }
            $('#net_weight_2_kg').val(Math.round(netWeight2));
        }

        // Bind calculation to weight input changes
        $('#gross_weight_kg, #tare_weight, #deduction_amount, #deduction_type').on('input change', calculateWeights);
    });
</script>
{% endblock %}